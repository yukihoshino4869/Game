<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Mario-style Scrolling Game</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<script>
// マリオ風スクロールゲーム - 要件をすべて実装したHTML+JavaScriptコード

// ゲームの状態管理: "title", "playing", "gameover", "stageclear"
let state = "title";

// キャンバスとコンテキスト取得
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

// キー入力の状態管理
const keysDown = {};  // 押されているキーを記録 (WASD用)
window.addEventListener("keydown", function(event) {
  // 全体: キー押下時の処理 (Enterで開始/再開、スペースで弾発射、Wジャンプ等)
  if(event.repeat) {
    // 長押しによるキーリピートは無視（弾連射やジャンプ多重防止）
    event.preventDefault();
    return;
  }
  const code = event.code;
  // ゲームの状態別のキー処理
  if(state === "title") {
    if(code === "Enter") {
      // タイトル画面でEnter: ゲーム開始
      startGame();
    }
    // タイトルでは他のキー操作は無視
  } else if(state === "gameover") {
    if(code === "Enter") {
      // ゲームオーバー画面でEnter: ゲーム再スタート
      startGame();
    }
  } else if(state === "stageclear") {
    if(code === "Enter") {
      // ステージクリア画面でEnter: タイトルに戻る
      state = "title";
    }
  } else if(state === "playing") {
    // プレイ中のキー処理
    if(code === "KeyW" || code === "ArrowUp") {
      // W(↑)キーでジャンプ（地面にいる場合のみ）
      if(player.onGround) {
        player.vy = -12;        // ジャンプ初速度 (自然なジャンプ挙動)
        player.onGround = false;
      }
    } else if(code === "Space") {
      // スペースキーで弾を発射
      shootBullet();
    }
    // 左右移動キーはkeysDownに記録 (連続処理はフレームごとのupdateで)
    if(code === "KeyA" || code === "ArrowLeft") {
      keysDown["left"] = true;
    }
    if(code === "KeyD" || code === "ArrowRight") {
      keysDown["right"] = true;
    }
  }
  // 画面スクロールを防ぐためのデフォルト動作無効化 (スペース/矢印のページスクロールを防ぐ)
  if(code === "Space" || code === "ArrowUp" || code === "ArrowDown" || code === "ArrowLeft" || code === "ArrowRight") {
    event.preventDefault();
  }
});
window.addEventListener("keyup", function(event) {
  const code = event.code;
  // 左右キー離したら移動停止
  if(code === "KeyA" || code === "ArrowLeft") {
    keysDown["left"] = false;
  }
  if(code === "KeyD" || code === "ArrowRight") {
    keysDown["right"] = false;
  }
  // 他のキー (WやSpace) は単発処理なので特にここで何もしない
});

// ゲームオブジェクトの定義
let player, enemies, bullets, blocks, flag;
const gravity = 0.5;        // 重力加速度
const moveSpeed = 3;        // プレイヤー移動速度
const bulletSpeed = 6;      // 弾の速度
const enemySpeed = 1.5;     // 敵の移動速度（ゆっくり）
let cameraX = 0;            // カメラ（スクロール）オフセットX
const levelWidth = 1500;    // スクロールマップ全体の幅
const groundY = 370;        // 地面のY座標 (地面の高さ)

// ゲーム開始/再スタート時の初期化処理
function startGame() {
  // プレイヤー初期化
  player = {
    x: 50,               // 開始位置 X
    y: groundY - 20,     // 開始位置 Y (地面上に立つように)
    width: 20,
    height: 20,
    vx: 0,
    vy: 0,
    onGround: true,      // 地面に立っているか
    facing: "right"      // プレイヤーの向き ("right" or "left")
  };
  // 弾と敵、ブロック、旗の初期化
  bullets = [];
  enemies = [];
  blocks = [];
  flag = null;
  cameraX = 0;
  // キー入力状態リセット
  keysDown["left"] = false;
  keysDown["right"] = false;
  // 敵の配置 (敵オブジェクトに x, y, width, height, vx, vy, onGround)
  // 敵1
  enemies.push({
    x: 300, y: groundY - 20, width: 20, height: 20,
    vx: -enemySpeed, vy: 0, onGround: true
  });
  // 敵2
  enemies.push({
    x: 600, y: groundY - 20, width: 20, height: 20,
    vx: enemySpeed, vy: 0, onGround: true
  });
  // 青い障害物ブロックの配置 (座標は左上基準, width, height)
  blocks.push({ x: 200, y: 300, width: 50, height: 20 });  // ブロック1
  blocks.push({ x: 260, y: 250, width: 50, height: 20 });  // ブロック2（段差）
  blocks.push({ x: 600, y: 300, width: 50, height: 20 });  // ブロック3
  // 地面上の障害物（例えば土管のようなブロック）
  blocks.push({ x: 400, y: groundY - 20, width: 50, height: 20 }); // ブロック4 (地面上)
  // ゴールの旗の配置 (旗ポールの位置とサイズ)
  flag = { x: 1400, y: groundY - 80, width: 10, height: 80 };
  state = "playing";
}

// 弾を発射する関数
function shootBullet() {
  // プレイヤーの向きに応じて弾を生成
  let bulletSize = 10;
  let bx = player.x + (player.facing === "right" ? player.width : -bulletSize);
  let by = player.y + player.height/2 - bulletSize/2;
  let bvx = player.facing === "right" ? bulletSpeed : -bulletSpeed;
  bullets.push({ x: bx, y: by, width: bulletSize, height: bulletSize, vx: bvx, vy: 0 });
}

// 当たり判定用の簡易AABBチェック関数
function isColliding(a, b) {
  return (a.x < b.x + b.width && a.x + a.width > b.x &&
          a.y < b.y + b.height && a.y + a.height > b.y);
}

// ゲームループ (毎フレーム呼ばれる)
function gameLoop() {
  // リクエストアニメーションフレームで次のフレームを予約
  requestAnimationFrame(gameLoop);

  // 現在の状態に応じて更新・描画処理
  if(state === "playing") {
    updateGame();   // ゲーム状態の更新 (物体の移動・衝突処理)
    drawGame();     // ゲーム画面の描画
  } else if(state === "title") {
    drawTitleScreen();
  } else if(state === "gameover") {
    drawGameOverScreen();
  } else if(state === "stageclear") {
    drawStageClearScreen();
  }
}

// ゲーム状態の更新処理 (playing時)
function updateGame() {
  // プレイヤーの水平移動速度をキー入力から設定
  player.vx = 0;
  if(keysDown["left"]) {
    player.vx = -moveSpeed;
    player.facing = "left";
  }
  if(keysDown["right"]) {
    player.vx = moveSpeed;
    player.facing = "right";
  }
  // 水平移動更新とブロック衝突処理（左右）
  player.x += player.vx;
  // ブロックとの横方向の当たり判定（プレイヤー）
  for(let block of blocks) {
    if(isColliding(player, block)) {
      if(player.vx > 0) {
        // 右方向に移動中に衝突 -> ブロックの左側に押し戻す
        player.x = block.x - player.width;
      } else if(player.vx < 0) {
        // 左方向に移動中に衝突 -> ブロックの右側に押し出す
        player.x = block.x + block.width;
      }
      // 衝突したので水平速度を0に
      player.vx = 0;
    }
  }
  // ワールドの端で止める
  if(player.x < 0) {
    player.x = 0;
  }
  if(player.x + player.width > levelWidth) {
    player.x = levelWidth - player.width;
  }
  // 垂直方向の速度更新（重力）と移動
  if(!player.onGround) {
    // 地面にいないなら重力加速
    player.vy += gravity;
  }
  player.y += player.vy;
  // ブロックとの縦方向の当たり判定（プレイヤー）
  // 下方向（落下）の衝突
  if(player.vy > 0) {
    // プレイヤーが地面またはブロック上に着地したか確認
    let landed = false;
    for(let block of blocks) {
      if(isColliding(player, block)) {
        // ブロックにめり込んだ場合
        if(player.y + player.height > block.y && player.prevY + player.height <= block.y) {
          // 真上から着地
          player.y = block.y - player.height; // ブロック上に立つ
          player.vy = 0;
          player.onGround = true;
          landed = true;
        }
      }
    }
    // 地面への着地 (ブロックに乗っていなければ地面を判定)
    if(!landed && player.y + player.height >= groundY) {
      player.y = groundY - player.height;
      player.vy = 0;
      player.onGround = true;
      landed = true;
    }
    if(landed) {
      // 着地した場合、垂直速度リセット済み
    }
  }
  // 上方向（ジャンプ）の衝突（ブロックに頭をぶつけた場合）
  if(player.vy < 0) {
    for(let block of blocks) {
      if(isColliding(player, block)) {
        if(player.y < block.y + block.height && player.prevY >= block.y + block.height) {
          // 下からブロックに衝突
          player.y = block.y + block.height;
          player.vy = 0;
        }
      }
    }
    // 天井に当たった場合の処理（画面上端で止める）
    if(player.y < 0) {
      player.y = 0;
      player.vy = 0;
    }
  }
  // プレイヤーがブロックから足を踏み外した場合の処理
  // （地面やブロック上にいなければ onGround を false にする）
  if(player.onGround) {
    // 足元に何もなければ落下開始
    let onSomething = false;
    // 足元判定用に1ピクセル下をチェック
    const footY = player.y + player.height + 1;
    if(footY >= groundY) {
      onSomething = true; // 地面がすぐ下にある
    }
    for(let block of blocks) {
      if(player.x < block.x + block.width && player.x + player.width > block.x) {
        // 水平に重なっているブロックについて足下確認
        if(Math.abs((player.y + player.height) - block.y) < 1) {
          // プレイヤーの足がブロックの上面とほぼ同じ高さ
          onSomething = true;
        }
      }
    }
    if(!onSomething) {
      player.onGround = false;
    }
  }
  // プレイヤーの前回位置を記録（次フレームのため）
  player.prevY = player.y;

  // 敵の更新（移動と重力）
  for(let enemy of enemies) {
    // 水平移動
    enemy.x += enemy.vx;
    // ブロックへの横衝突で方向転換
    for(let block of blocks) {
      if(isColliding(enemy, block)) {
        if(enemy.vx > 0) {
          enemy.x = block.x - enemy.width;
        } else {
          enemy.x = block.x + block.width;
        }
        enemy.vx *= -1; // 方向反転
      }
    }
    // 画面端で方向転換
    if(enemy.x < 0) {
      enemy.x = 0;
      enemy.vx = enemySpeed;
    }
    if(enemy.x + enemy.width > levelWidth) {
      enemy.x = levelWidth - enemy.width;
      enemy.vx = -enemySpeed;
    }
    // 垂直方向（重力）
    if(!enemy.onGround) {
      enemy.vy += gravity;
    }
    enemy.y += enemy.vy;
    // 地面またはブロックへの着地判定（敵）
    let enemyLanded = false;
    // ブロック上に着地
    for(let block of blocks) {
      if(isColliding(enemy, block)) {
        if(enemy.y + enemy.height > block.y && enemy.y - enemy.vy + enemy.height <= block.y) {
          enemy.y = block.y - enemy.height;
          enemy.vy = 0;
          enemy.onGround = true;
          enemyLanded = true;
        }
      }
    }
    // 地面への着地
    if(!enemyLanded && enemy.y + enemy.height >= groundY) {
      enemy.y = groundY - enemy.height;
      enemy.vy = 0;
      enemy.onGround = true;
      enemyLanded = true;
    }
    if(!enemyLanded) {
      enemy.onGround = false;
    }
  }

  // 弾の更新（移動・衝突判定）
  for(let bullet of bullets) {
    bullet.x += bullet.vx;
  }
  // 弾と敵の衝突判定、および弾・敵の削除
  for(let i = bullets.length - 1; i >= 0; i--) {
    let bullet = bullets[i];
    // 画面外(レベル外)に出た弾を削除
    if(bullet.x + bullet.width < 0 || bullet.x > levelWidth) {
      bullets.splice(i, 1);
      continue;
    }
    // 弾と敵の当たり判定
    for(let j = enemies.length - 1; j >= 0; j--) {
      let enemy = enemies[j];
      if(isColliding(bullet, enemy)) {
        // 弾が敵に当たった -> 敵を倒し、弾も消える
        enemies.splice(j, 1);
        bullets.splice(i, 1);
        break; // この弾は消えたのでループ離脱
      }
    }
  }

  // プレイヤーと敵の衝突判定
  for(let enemy of enemies) {
    if(isColliding(player, enemy)) {
      if(player.vy > 0) {
        // 上から踏んだ場合（プレイヤーが落下中）
        // 敵を倒す
        enemies = enemies.filter(e => e !== enemy);
        // プレイヤーに軽いバウンドを与える
        player.vy = -8;
        player.onGround = false;
      } else {
        // 側面または下から当たった場合 -> ゲームオーバー
        state = "gameover";
        return; // 更新処理中断
      }
    }
  }

  // プレイヤーと旗（ゴール）の衝突判定
  if(isColliding(player, flag)) {
    // ゴールに到達 -> ステージクリア
    state = "stageclear";
    return;
  }

  // カメラ（スクロール位置）の更新
  // プレイヤーを画面中央に追従（ただしステージ端では固定）
  cameraX = player.x + player.width/2 - canvas.width/2;
  if(cameraX < 0) cameraX = 0;
  if(cameraX > levelWidth - canvas.width) cameraX = levelWidth - canvas.width;
}

// ゲーム画面の描画処理
function drawGame() {
  // 背景を空色で塗りつぶし
  ctx.fillStyle = "#87CEEB";  // 空の色 (スカイブルー)
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  // 地面を緑色で描画
  ctx.fillStyle = "#228B22";  // ground (forest green)
  ctx.fillRect(0, groundY - cameraY, canvas.width, canvas.height - groundY);
  // ブロックを青色で描画
  ctx.fillStyle = "blue";
  for(let block of blocks) {
    // ブロックをカメラ相対位置で描画
    ctx.fillRect(block.x - cameraX, block.y - 0, block.width, block.height);
  }
  // 弾を小さな黄色の球で描画
  ctx.fillStyle = "yellow";
  for(let bullet of bullets) {
    // 弾を円形で描画
    ctx.beginPath();
    ctx.arc(bullet.x - cameraX + bullet.width/2, bullet.y + bullet.height/2, bullet.width/2, 0, Math.PI*2);
    ctx.fill();
  }
  // 敵を赤色の四角で描画
  ctx.fillStyle = "red";
  for(let enemy of enemies) {
    ctx.fillRect(enemy.x - cameraX, enemy.y - 0, enemy.width, enemy.height);
  }
  // プレイヤーを黒色の四角で描画
  ctx.fillStyle = "black";
  ctx.fillRect(player.x - cameraX, player.y - 0, player.width, player.height);
  // ゴールの旗を描画 (赤い棒と白い旗)
  // ポール（棒）
  ctx.fillStyle = "red";
  ctx.fillRect(flag.x - cameraX, flag.y - 0, 5, flag.height);
  // 白い旗
  ctx.fillStyle = "white";
  ctx.fillRect(flag.x - cameraX + 5, flag.y + 0, 15, 10);
}

// タイトル画面の描画
function drawTitleScreen() {
  ctx.fillStyle = "blue";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.font = "48px sans-serif";
  const titleText = "demo";
  const titleWidth = ctx.measureText(titleText).width;
  ctx.fillText(titleText, (canvas.width - titleWidth) / 2, canvas.height/2 - 20);
  ctx.font = "20px sans-serif";
  const instText = "Press Enter to Start";
  const instWidth = ctx.measureText(instText).width;
  ctx.fillText(instText, (canvas.width - instWidth) / 2, canvas.height/2 + 20);
}

// ゲームオーバー画面の描画
function drawGameOverScreen() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.font = "40px sans-serif";
  const overText = "Game Over";
  const overWidth = ctx.measureText(overText).width;
  ctx.fillText(overText, (canvas.width - overWidth) / 2, canvas.height/2 - 20);
  ctx.font = "20px sans-serif";
  const retryText = "Press Enter to Restart";
  const retryWidth = ctx.measureText(retryText).width;
  ctx.fillText(retryText, (canvas.width - retryWidth) / 2, canvas.height/2 + 20);
}

// ステージクリア画面の描画
function drawStageClearScreen() {
  ctx.fillStyle = "black";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.font = "40px sans-serif";
  const clearText = "Stage Clear!";
  const clearWidth = ctx.measureText(clearText).width;
  ctx.fillText(clearText, (canvas.width - clearWidth) / 2, canvas.height/2 - 20);
  ctx.font = "20px sans-serif";
  const backText = "Press Enter to Title";
  const backWidth = ctx.measureText(backText).width;
  ctx.fillText(backText, (canvas.width - backWidth) / 2, canvas.height/2 + 20);
}

// 初回はタイトル画面を描画
drawTitleScreen();
// ゲームループ開始
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
