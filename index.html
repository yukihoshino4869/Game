
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マリオ風ゲーム 完全修正版</title>
  <style>
    body { margin: 0; overflow: hidden; background: #000; }
    canvas { display: block; background: #87ceeb; }
  </style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="400"></canvas>
<audio id="bgm" loop autoplay>
  <source src="https://upload.wikimedia.org/wikipedia/commons/4/42/Mario_Underground_theme.ogg" type="audio/ogg">
</audio>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let state = "title";
let keys = {};
let player;
let bullets = [];
let enemies = [];
let blocks = [];
let holes = [];
let flag;
let jumpCount = 0;
const gravity = 0.5;
const groundY = 350;
const mapWidth = 3200;

const playerImg = new Image();
playerImg.src = "https://i.imgur.com/dxjd7FB.png"; // プレイヤーのドット絵画像
const enemyImg = new Image();
enemyImg.src = "https://i.imgur.com/yNyLkYV.png"; // 敵のドット絵画像

document.addEventListener("keydown", e => {
  keys[e.key] = true;
  if (e.key === "Enter") {
    if (state === "title" || state === "gameover" || state === "stageclear") startGame();
  }
  if (state === "playing" && e.key === "h") shoot(); // hキーで弾発射
});
document.addEventListener("keyup", e => keys[e.key] = false);

function startGame() {
  state = "playing";
  player = { x: 50, y: groundY - 32, vx: 0, vy: 0, width: 32, height: 32, onGround: true };
  jumpCount = 0;
  bullets = [];
  enemies = [];
  blocks = [];
  holes = [];

  for (let i = 0; i < 8; i++) {
    enemies.push({
      x: 600 + i * 300,
      y: groundY - 32,
      vx: -1,
      vy: 0,
      width: 32,
      height: 32,
      onGround: true
    });
  }

  for (let i = 0; i < 20; i++) {
    let x = 200 + Math.floor(Math.random() * (mapWidth - 300));
    let y = 250 + Math.floor(Math.random() * 80);
    blocks.push({ x, y, width: 50, height: 20 });
  }

  for (let i = 0; i < 10; i++) {
    let x = 300 + Math.floor(Math.random() * (mapWidth - 600));
    holes.push({ x, width: 60 });
  }

  flag = { x: mapWidth - 100, y: groundY - 80, width: 10, height: 80 };
}

function shoot() {
  bullets.push({
    x: player.x + player.width / 2,
    y: player.y + player.height / 2,
    vx: 5,
    width: 5,
    height: 5
  });
}

function isCollide(a, b) {
  return a.x < b.x + b.width && a.x + a.width > b.x &&
         a.y < b.y + b.height && a.y + a.height > b.y;
}

function update() {
  if (state !== "playing") return;

  player.vx = 0;
  if (keys["a"]) player.vx = -2;
  if (keys["d"]) player.vx = 2;
  if ((keys["w"] || keys["ArrowUp"]) && jumpCount < 2 && !keys["__jumping"]) {
    player.vy = -10;
    player.onGround = false;
    jumpCount++;
    keys["__jumping"] = true;
  }
  if (!(keys["w"] || keys["ArrowUp"])) keys["__jumping"] = false;

  player.x += player.vx;
  player.vy += gravity;
  player.y += player.vy;

  // 穴に完全に落ちたらゲームオーバー
  if (player.y > canvas.height) {
    state = "gameover";
  }

  holes.forEach(hole => {
    if (player.y + player.height >= groundY &&
        player.x + player.width / 2 > hole.x &&
        player.x + player.width / 2 < hole.x + hole.width) {
      // 落下開始（地面にいない）
      player.onGround = false;
    }
  });

  blocks.forEach(b => {
    if (isCollide(player, b)) {
      if (player.vy > 0 && player.y + player.height <= b.y + player.vy) {
        player.y = b.y - player.height;
        player.vy = 0;
        player.onGround = true;
        jumpCount = 0;
      } else if (player.vx > 0) {
        player.x = b.x - player.width;
      } else if (player.vx < 0) {
        player.x = b.x + b.width;
      }
    }
  });

  if (player.y >= groundY - player.height) {
    player.y = groundY - player.height;
    player.vy = 0;
    player.onGround = true;
    jumpCount = 0;
  }

  player.x = Math.max(0, Math.min(player.x, mapWidth - player.width));

  bullets.forEach(b => b.x += b.vx);
  bullets = bullets.filter(b => b.x < mapWidth);

  enemies.forEach(e => {
    e.vx = e.x < player.x ? 1 : -1;
    e.vy += gravity;
    e.y += e.vy;

    // 敵ブロックに衝突
    blocks.forEach(b => {
      if (isCollide(e, b)) {
        if (e.vy > 0 && e.y + e.height <= b.y + e.vy) {
          e.y = b.y - e.height;
          e.vy = 0;
          e.onGround = true;
        }
      }
    });

    // 敵が地面に着地
    if (e.y + e.height >= groundY) {
      e.y = groundY - e.height;
      e.vy = 0;
      e.onGround = true;
    }

    e.x += e.vx;
  });

  // 敵が穴に落ちる
  enemies = enemies.filter(e => e.y <= canvas.height);

  bullets.forEach(b => {
    for (let i = 0; i < enemies.length; i++) {
      if (isCollide(b, enemies[i])) {
        enemies.splice(i, 1);
        b.hit = true;
        break;
      }
    }
  });
  bullets = bullets.filter(b => !b.hit);

  enemies.forEach(e => {
    if (isCollide(player, e)) {
      if (player.vy > 0) {
        player.vy = -8;
        enemies = enemies.filter(en => en !== e);
      } else {
        state = "gameover";
      }
    }
  });

  if (isCollide(player, flag)) state = "stageclear";
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (state === "title") {
    ctx.fillStyle = "blue";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "48px sans-serif";
    ctx.fillText("demo", 340, 180);
    ctx.font = "20px sans-serif";
    ctx.fillText("Press Enter to Start", 310, 220);
    return;
  }

  if (state === "gameover" || state === "stageclear") {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "white";
    ctx.font = "40px sans-serif";
    ctx.fillText(state === "gameover" ? "Game Over" : "Stage Clear!", 270, 200);
    ctx.font = "20px sans-serif";
    ctx.fillText("Press Enter to Restart", 280, 240);
    return;
  }

  let camX = player.x - 400;
  camX = Math.max(0, Math.min(camX, mapWidth - canvas.width));

  ctx.fillStyle = "green";
  ctx.fillRect(-camX, groundY, mapWidth, 50);

  ctx.fillStyle = "black";
  holes.forEach(h => ctx.clearRect(h.x - camX, groundY, h.width, 50));

  ctx.fillStyle = "blue";
  blocks.forEach(b => ctx.fillRect(b.x - camX, b.y, b.width, b.height));

  ctx.drawImage(playerImg, player.x - camX, player.y, player.width, player.height);

  ctx.fillStyle = "yellow";
  bullets.forEach(b => ctx.fillRect(b.x - camX, b.y, b.width, b.height));

  enemies.forEach(e => {
    ctx.drawImage(enemyImg, e.x - camX, e.y, e.width, e.height);
  });

  ctx.fillStyle = "white";
  ctx.fillRect(flag.x - camX, flag.y, flag.width, flag.height);
}

function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
